<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cart</title>
    <style>
      :root {
        color-scheme: dark;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, sans-serif;
        background: linear-gradient(180deg, hsl(0 0% var(--bg-start)) 0%, hsl(0 0% calc(var(--bg-start) + 6%)) 40%, hsl(0 0% calc(var(--bg-end) - 6%)) 70%, hsl(0 0% var(--bg-end)) 100%);
        color: var(--text-color, #f8f3ef);
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 32px 24px 64px;
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
      }

      .brand {
        font-family: "Ballet", "Great Vibes", cursive;
        font-size: 32px;
        letter-spacing: 0.04em;
        color: inherit;
        text-decoration: none;
      }

      .back-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: var(--text-color, #f8f3ef);
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      .back-button:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.08);
      }

      .lang {
        display: flex;
        gap: 8px;
      }

      .lang button {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: var(--text-color, #f8f3ef);
        font-size: 12px;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        cursor: pointer;
      }

      .lang button.active {
        background: rgba(255, 255, 255, 0.12);
      }

      .title {
        margin: 0 0 24px;
        font-size: 28px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
      }

      .cart-grid {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 32px;
      }

      .cart-item {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .cart-item img {
        width: 100%;
        border-radius: 12px;
        background: #111;
      }

      .item-meta {
        display: grid;
        gap: 6px;
      }

      .item-name {
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .item-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        opacity: 0.7;
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .qty {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .qty button {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: inherit;
        cursor: pointer;
      }

      .remove {
        margin-top: 6px;
        border: none;
        background: none;
        color: var(--text-color, #f8f3ef);
        opacity: 0.6;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
      }

      .summary {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        padding: 24px;
        display: grid;
        gap: 12px;
        height: fit-content;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-size: 12px;
      }

      .summary-total {
        margin-top: 8px;
        font-size: 16px;
      }

      .checkout {
        margin-top: 16px;
        padding: 12px 18px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-color, #f8f3ef);
        letter-spacing: 0.18em;
        text-transform: uppercase;
        cursor: pointer;
      }

      .checkout-form {
        margin-top: 18px;
        display: grid;
        gap: 10px;
      }

      .checkout-form label {
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        opacity: 0.7;
      }

      .checkout-form input {
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.3);
        color: var(--text-color, #f8f3ef);
      }

      .empty {
        text-align: center;
        padding: 60px 0;
        opacity: 0.8;
      }

      .empty button {
        margin-top: 16px;
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: var(--text-color, #f8f3ef);
        letter-spacing: 0.18em;
        text-transform: uppercase;
        cursor: pointer;
      }

      @media (max-width: 900px) {
        .page {
          padding: 24px 18px 56px;
        }

        .page-header {
          flex-wrap: wrap;
          gap: 12px;
        }

        .brand {
          font-size: 28px;
        }

        .cart-grid {
          grid-template-columns: 1fr;
        }

        .summary {
          order: 2;
        }

        .cart-item {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .cart-item img {
          max-width: 160px;
        }
      }

      @media (max-width: 600px) {
        .item-row {
          gap: 10px;
        }

        .checkout {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="page-header">
        <button class="back-button" id="backButton" aria-label="Back">
          ←
        </button>
        <a class="brand" href="index.html" data-i18n="brand">Yokatta</a>
        <div class="lang">
          <button data-lang="en">EN</button>
          <button data-lang="ru">RU</button>
        </div>
      </header>

      <h1 class="title" data-i18n="title">Cart</h1>

      <div class="empty" id="cartEmpty">
        <div data-i18n="empty">Your cart is empty</div>
        <button onclick="location.href='index.html'" data-i18n="continue">
          Continue shopping
        </button>
      </div>

      <div class="cart-grid" id="cartFilled" hidden>
        <div>
          <div class="cart-item">
            <img src="bag.jpg" alt="" />
            <div class="item-meta">
              <div class="item-name">Yokatta Tote</div>
              <div class="item-row">
                <span>Size: M</span>
                <span>Color: Black</span>
                <span>$0</span>
              </div>
              <div class="qty">
                <button>-</button>
                <span>1</span>
                <button>+</button>
              </div>
              <button class="remove">Remove</button>
            </div>
          </div>
        </div>
        <aside class="summary">
          <div class="summary-row">
            <span data-i18n="subtotal">Subtotal</span>
            <span>$0</span>
          </div>
          <div class="summary-row">
            <span data-i18n="shipping">Shipping</span>
            <span>—</span>
          </div>
          <div class="summary-row summary-total">
            <span data-i18n="total">Total</span>
            <span>$0</span>
          </div>
          <button class="checkout" data-i18n="checkout">
            Proceed to checkout
          </button>
          <form class="checkout-form" id="checkoutForm">
            <label>Name</label>
            <input type="text" id="shipName" required />
            <label>Email</label>
            <input type="email" id="shipEmail" required />
            <label>Phone</label>
            <input type="tel" id="shipPhone" required />
            <label>Address</label>
            <input type="text" id="shipAddress" required />
            <label>City</label>
            <input type="text" id="shipCity" required />
            <label>Country</label>
            <input type="text" id="shipCountry" required />
            <label>Postal code</label>
            <input type="text" id="shipPostal" required />
            <label>Card number</label>
            <input type="text" id="cardNumber" required />
            <label>Expiry (MM/YY)</label>
            <input type="text" id="cardExpiry" required />
            <label>CVC</label>
            <input type="text" id="cardCvc" required />
            <button class="checkout" type="submit">Place order</button>
          </form>
        </aside>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://kbguphxloslhdcpbxqub.supabase.co";
      const SUPABASE_KEY = "sb_publishable__Ve_OcWmEs8Hpns4PA-Teg_6gb7S-iO";
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const translations = {
        en: {
          brand: "Yokatta",
          title: "Cart",
          empty: "Your cart is empty",
          continue: "Continue shopping",
          subtotal: "Subtotal",
          shipping: "Shipping",
          total: "Total",
          checkout: "Proceed to checkout",
        },
        ru: {
          brand: "Yokatta",
          title: "Корзина",
          empty: "Ваша корзина пуста",
          continue: "Продолжить покупки",
          subtotal: "Промежуточный итог",
          shipping: "Доставка",
          total: "Итого",
          checkout: "Перейти к оплате",
        },
      };

      const applyLanguage = (lang) => {
        const strings = translations[lang] || translations.en;
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (strings[key]) el.textContent = strings[key];
        });
        document.querySelectorAll(".lang button").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.lang === lang);
        });
        localStorage.setItem("lang", lang);
      };

      document.querySelectorAll(".lang button").forEach((btn) => {
        btn.addEventListener("click", () => applyLanguage(btn.dataset.lang));
      });

      document
        .getElementById("backButton")
        .addEventListener("click", () => history.back());

      applyLanguage(localStorage.getItem("lang") || "en");

      let currentItems = [];
      const renderCart = async () => {
        const { data } = await supabaseClient.auth.getSession();
        const session = data.session;
        if (!session) {
          document.getElementById("cartEmpty").hidden = false;
          document.getElementById("cartFilled").hidden = true;
          return;
        }
        const { data: items } = await supabaseClient
          .from("cart_items")
          .select("*")
          .eq("user_id", session.user.id);

        if (!items || items.length === 0) {
          document.getElementById("cartEmpty").hidden = false;
          document.getElementById("cartFilled").hidden = true;
          return;
        }

        currentItems = items;
        document.getElementById("cartEmpty").hidden = true;
        const cartFilled = document.getElementById("cartFilled");
        cartFilled.hidden = false;
        const list = cartFilled.querySelector("div");
        list.innerHTML = items
          .map(
            (item) => `
            <div class="cart-item">
              <img src="bag.jpg" alt="" />
              <div class="item-meta">
                <div class="item-name">${item.name}</div>
                <div class="item-row">
                  <span>Size: ${item.size || "-"}</span>
                  <span>Color: ${item.color || "-"}</span>
                  <span>$${item.price || 0}</span>
                </div>
                <div class="qty">
                  <span>${item.quantity || 1}</span>
                </div>
                <button class="remove" data-id="${item.id}">Remove</button>
              </div>
            </div>
          `
          )
          .join("");

        const subtotal = items.reduce(
          (sum, item) => sum + (item.price || 0) * (item.quantity || 1),
          0
        );
        cartFilled.querySelector(".summary-row span:last-child").textContent =
          `$${subtotal}`;
        cartFilled.querySelector(".summary-total span:last-child").textContent =
          `$${subtotal}`;

        cartFilled.querySelectorAll(".remove").forEach((btn) => {
          btn.addEventListener("click", async () => {
            await supabaseClient.from("cart_items").delete().eq("id", btn.dataset.id);
            renderCart();
          });
        });
      };

      document
        .getElementById("checkoutForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const { data } = await supabaseClient.auth.getSession();
          const session = data.session;
          if (!session || currentItems.length === 0) return;
          const cardNumber = document.getElementById("cardNumber").value.trim();
          const last4 = cardNumber.slice(-4);
          await supabaseClient.from("orders").insert({
            user_id: session.user.id,
            items: currentItems,
            total: currentItems.reduce(
              (sum, item) => sum + (item.price || 0) * (item.quantity || 1),
              0
            ),
            shipping: {
              name: document.getElementById("shipName").value.trim(),
              email: document.getElementById("shipEmail").value.trim(),
              phone: document.getElementById("shipPhone").value.trim(),
              address: document.getElementById("shipAddress").value.trim(),
              city: document.getElementById("shipCity").value.trim(),
              country: document.getElementById("shipCountry").value.trim(),
              postal: document.getElementById("shipPostal").value.trim(),
            },
            card_last4: last4,
          });
          alert("Order placed.");
        });

      renderCart();
    </script>
  </body>
</html>
